box: nodesource/node:trusty
# Build definition
build:
  # The steps that will be executed on build
    steps:
        - script:
            name: set up permissions
            code: |
                export NODE_ENV=development
                chmod 777 -R .
                chmod 777 -R $WERCKER_CACHE_DIR

        - script:
            name: install npm@2
            code: |
                npm cache clean
                sudo npm i -g npm

        - npm-install

        - script:
            name: npm postinstall
            code: |
                rm -rf node_modules/@local
                ./node_modules/.bin/linklocal link -r
                ./node_modules/.bin/linklocal list -r | ./node_modules/.bin/bulk -c 'npm install'

        # gulp build the docs
        - hgen/gulp:
            tasks: build

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            channel: notifications
            username: megatron
            notify_on: "failed"

deploy:
    steps:
        - s3sync:
            source_dir: build/
            delete-removed: true
            bucket-url: $AWS_BUCKET_URL
            key-id: $AWS_ACCESS_KEY_ID
            key-secret: $AWS_SECRET_ACCESS_KEY

        - script:
            name: add redirect files
            code: |
                cd legacy-urls
                npm install
                node ./index.js

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            channel: notifications
            username: soundwave
            notify_on: "failed"
